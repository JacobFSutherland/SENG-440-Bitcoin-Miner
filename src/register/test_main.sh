#!/bin/bash

set -o pipefail

PROGRAM=./main

function fail() {
  echo -n -e '\e[1;31m[ERROR]\e[0m '
  echo -e "$1"
  exit 1
}

function do_run() {
  {
    IFS=$'\n' read -r -d '' stderr;
    IFS=$'\n' read -r -d '' output;
  } < <((printf '\0%s\0' "$(eval "$PROGRAM $2")" 1>&2) 2>&1)

  expected=$3
  actual=$output

  if [ "$actual" != "$expected" ]; then
    echo FAILED
    msg="expected:\n$expected\nbut got:\n$actual"
    if [ "$stderr" != "" ]; then
      msg="$msg\nstderr:\n$stderr"
    fi
    fail "$msg"
  fi
}

function run() {
  echo -n "Testing $1 ... "
  do_run "$@"
  echo ok
}

run one "16 0000000000000000000000000000000000000000000000000000000000000000 1" $'0000b04b'
run two "16 0000000000000000000000000000000000000000000000000000000000000000 2" $'0000b04b\n00003d45'
run many_easy "8 0123456789012345678901234567890123456789012345678901234567890123 100" $'000001bb\n00000034\n00000097\n0000010f\n000001ef\n0000006f\n0000017c\n0000018a\n00000006\n000000a3\n00000173\n00000043\n0000001a\n00000309\n00000068\n0000007c\n00000079\n00000183\n00000165\n00000026\n00000138\n00000110\n00000052\n00000016\n00000030\n0000000e\n0000005b\n00000025\n0000009b\n00000198\n0000006c\n0000018f\n00000026\n0000001f\n000000aa\n000001ff\n00000045\n0000011c\n00000073\n00000141\n00000221\n00000161\n000000e6\n00000032\n000000f2\n00000311\n00000012\n00000066\n000000d9\n0000013a\n00000387\n00000056\n00000023\n00000072\n00000101\n00000190\n00000096\n00000148\n000001f2\n0000006c\n0000002c\n000000a8\n00000066\n0000019c\n000002f2\n00000144\n00000074\n00000151\n000000aa\n00000046\n00000185\n00000170\n00000086\n0000013c\n0000001b\n00000009\n00000061\n00000050\n0000009e\n0000016c\n000001fb\n00000039\n000002ae\n000000d8\n0000018e\n00000059\n0000011f\n0000006c\n0000009c\n0000004f\n0000013c\n0000004d\n000001b9\n00000013\n000000cb\n000000fd\n00000044\n0000012f\n000000b2\n000003d4'
run few_hard "16 0000000000000000000000000000000000000000000000000000000000000001 10" $'0000b04b\n00003d45\n0000b7a0\n0000f891\n00005717\n0000cd1a\n000023da\n0002447c\n00005be1\n00004b3f'
run one_very_hard "20 0123456789012345678901234567890123456789012345678901234567890123 1" $'001913ca'