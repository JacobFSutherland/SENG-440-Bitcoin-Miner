#!/bin/bash

set -o pipefail

PROGRAM=./main

function fail() {
  echo -n -e '\e[1;31m[ERROR]\e[0m '
  echo -e "$1"
  exit 1
}

function do_run() {
  {
    IFS=$'\n' read -r -d '' stderr;
    IFS=$'\n' read -r -d '' output;
  } < <((printf '\0%s\0' "$(eval "$PROGRAM $2")" 1>&2) 2>&1)

  expected=$3
  actual=$output

  if [ "$actual" != "$expected" ]; then
    echo FAILED
    msg="expected:\n$expected\nbut got:\n$actual"
    if [ "$stderr" != "" ]; then
      msg="$msg\nstderr:\n$stderr"
    fi
    fail "$msg"
  fi
}

function run() {
  echo -n "Testing $1 ... "
  do_run "$@"
  echo ok
}

run one "16 0000000000000000000000000000000000000000000000000000000000000000 1" $'00004669'
run two "16 0000000000000000000000000000000000000000000000000000000000000000 2" $'00004669\n00009ee0'
run many_easy "8 0123456789012345678901234567890123456789012345678901234567890123 100" $'000000bf\n000000a1\n000000eb\n00000086\n00000241\n000000fd\n0000015c\n0000004a\n000000c9\n00000283\n00000122\n00000035\n00000140\n00000071\n000000d0\n0000011b\n00000033\n0000011b\n0000015e\n00000029\n000000e0\n000000f4\n00000007\n000001c8\n0000007e\n000001bd\n000000a9\n0000003e\n000003e0\n0000013d\n0000018f\n0000005b\n00000060\n000000db\n00000062\n00000063\n00000006\n00000155\n00000266\n000000e6\n00000083\n00000049\n00000051\n0000007b\n000001c3\n0000008f\n000000a9\n0000021f\n00000016\n00000073\n000000a3\n0000012b\n00000019\n00000215\n0000001a\n000003f3\n00000016\n00000056\n0000016b\n000000c4\n00000052\n0000007f\n00000066\n000000be\n00000156\n0000005b\n0000001e\n00000000\n00000305\n00000367\n0000008e\n00000014\n0000009c\n000000af\n00000048\n00000040\n00000121\n00000504\n00000056\n000000be\n0000003d\n00000094\n000000b0\n0000002a\n0000002e\n00000101\n000000a9\n000000e6\n0000007c\n00000158\n0000013b\n00000012\n00000157\n000000e5\n0000009f\n00000181\n00000139\n00000081\n00000122\n00000035'
run few_hard "16 0000000000000000000000000000000000000000000000000000000000000001 10" $'000147a4\n0000fbcb\n0000650e\n0001c006\n00003e00\n0000e912\n0000326b\n0003e7a8\n00018ddc\n00034569'
run one_very_hard "20 0123456789012345678901234567890123456789012345678901234567890123 1" $'00081730'